# K8s 部署 Go 项目

## 1. 创建项目

### 1.1 填写基本名称

在 KubeSphere 控制台中创建部署，填写项目/应用的基本名称。

![An image](/images/RD/k8s-go-1.png)

### 1.2 填写容器信息

配置容器镜像、资源限制、环境变量等。

![An image](/images/RD/k8s-go-2.png)

![An image](/images/RD/k8s-go-3.png)

![An image](/images/RD/k8s-go-4.png)

### 1.3 存储设置

1. **提前为项目创建 PVC**：

   - 在 KubeSphere 中创建持久卷声明（PVC）
   - 将 PVC 挂载到容器的 `/app/runtime` 目录

![An image](/images/RD/k8s-go-5.png)

2. **PVC 等待挂载到 PV**：

   - 创建 PVC 后，状态为 "Pending"

![An image](/images/RD/k8s-go-6.png)

3. **创建 PV**：

   ```yaml
   apiVersion: v1
   kind: PersistentVolume
   metadata:
     name: go-app-pv
   spec:
     capacity:
       storage: 10Gi
     accessModes:
       - ReadWriteOnce
     persistentVolumeReclaimPolicy: Retain
     storageClassName: ''
     hostPath:
       path: /data/go-app
   ```

![An image](/images/RD/k8s-go-7.png)

4. **编辑 PVC 的 YAML，绑定到指定的 PV**：

   ```yaml
   apiVersion: v1
   kind: PersistentVolumeClaim
   metadata:
     name: go-app-pvc
   spec:
     accessModes:
       - ReadWriteOnce
     resources:
       requests:
         storage: 10Gi
     volumeName: go-app-pv # 指定 PV 名称
     storageClassName: ''
   ```

![An image](/images/RD/k8s-go-8.png)

5. **等待自动绑定成功并且正常运行**：
   - 查看 PVC 状态变为 "Bound"
   - 部署状态变为 "运行中"

![An image](/images/RD/k8s-go-9.png)

![An image](/images/RD/k8s-go-10.png)

## 2. 创建服务

### 2.1 创建自定义服务，指定工作负载

![An image](/images/RD/k8s-go-11.png)

1. **基本设置**：

   - 选择工作负载
   - 设置服务名称

![An image](/images/RD/k8s-go-12.png)

2. **服务设置**：

   - 选择端口映射
   - 配置协议和容器端口

![An image](/images/RD/k8s-go-13.png)

3. **高级设置**：

   - 设置外部访问模式为 `NodePort`

![An image](/images/RD/k8s-go-14.png)

4. **自动分配端口**：
   - K8s 自动分配节点端口（如 `30080`）

![An image](/images/RD/k8s-go-15.png)

## 3. 运行

![An image](/images/RD/k8s-go-16.png)

使用任意节点 IP + 端口访问服务：

```
http://192.168.1.181:30080
http://192.168.1.182:30080
http://192.168.1.183:30080
http://192.168.1.184:30080
```

## 4. 问题排查

### 网络连接问题

**环境信息**：

- 主机 IP：192.168.1.215
- 其他机器 IP：192.168.1.67
- K8s 安装在 VM 中，使用桥接模式

**节点信息**： | 节点名称 | IP | |--------------|----------------| | k8s-master | 192.168.1.181 | | k8s-node1 | 192.168.1.182 | | k8s-node2 | 192.168.1.183 | | k8s-node3 | 192.168.1.184 |

**问题描述**：容器内能访问互联网，也能访问到各节点 IP，但是访问不了主机 IP，更访问不了主机的局域网。

**原因分析**：网络服务没有启动或配置不正确。

**解决方案**：

1. **检查网络配置**：

   ```bash
   # 检查网络插件状态
   kubectl get pods -n kube-system | grep -E 'calico|flannel'

   # 检查节点网络
   ip route show
   ```

2. **配置网络策略**（如果需要）：

   ```yaml
   apiVersion: networking.k8s.io/v1
   kind: NetworkPolicy
   metadata:
     name: allow-host-access
   spec:
     podSelector:
       matchLabels:
         app: go-app
     policyTypes:
       - Egress
     egress:
       - to:
           - ipBlock:
               cidr: 192.168.1.215/32
         ports:
           - protocol: TCP
             port: 80
           - protocol: TCP
             port: 443
   ```

3. **检查防火墙规则**：

   ```bash
   # 在主机上检查防火墙
   sudo iptables -L -n | grep 192.168.1

   # 临时关闭防火墙测试
   sudo systemctl stop firewalld  # CentOS/RHEL
   sudo ufw disable              # Ubuntu
   ```

4. **验证网络连通性**：

   ```bash
   # 从容器内部测试连接
   kubectl exec <pod-name> -- ping 192.168.1.215
   kubectl exec <pod-name> -- curl http://192.168.1.215:80
   ```

5. **调整网络配置**：

   ```bash
   # 如果是 Calico 网络插件
   kubectl get ippools -o yaml

   # 确保 IP 池包含主机网络段
   ```

## 5. 部署验证

### 检查部署状态

```bash
# 查看部署状态
kubectl get deployment go-app

# 查看 Pod 状态
kubectl get pods -l app=go-app

# 查看服务状态
kubectl get svc go-app-service

# 查看 PVC/PV 状态
kubectl get pvc
kubectl get pv
```

### 访问测试

```bash
# 测试服务访问
curl http://192.168.1.181:30080/health
curl http://192.168.1.182:30080/api/v1/status
```

## 6. 监控和日志

### 查看应用日志

```bash
kubectl logs -f deployment/go-app
```

### 监控资源使用

```bash
kubectl top pods -l app=go-app
kubectl describe deployment go-app
```

## 7. 注意事项

1. **存储**：确保主机路径 `/data/go-app` 存在且有正确权限
2. **网络**：NodePort 范围默认是 30000-32767
3. **安全**：生产环境建议使用 Ingress + TLS
4. **备份**：定期备份 PV 中的重要数据

---

**部署成功标志**：

1. 所有 Pod 状态为 "Running"
2. PVC 状态为 "Bound"
3. 服务可通过 NodePort 访问
4. 应用功能正常响应
