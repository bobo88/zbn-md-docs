# V1.3.0 密码本的流程构想

**日期：** 2025.05.30

## 前言

密码本的核心用户痛点问题：**我的密码数据是否安全？是否仅自己可见？**

因此，必须做到让**用户自己掌握加密秘钥**。

- **密码** 永不明文上传
- **数据** 前端加密后上传
- **密钥** 掌握在用户自己手里

## 一、流程构想

1. **用户设置主密码**
2. **小程序前端派生 AES 密钥**（PBKDF2）
3. **用户输入的密码数据使用 AES 加密**
4. **加密后的数据上传至云数据库**（无需明文传输）
5. **用户想查看密码：**
   - 输入主密码（或生物认证）
   - 前端从云端拉取密文
   - 本地用 AES 密钥解密
   - 展示明文（10 秒后清除）

> **备注：** 主密码一旦丢失，数据将不可恢复（安全冗余）。

## 二、密码本小程序安全架构图

```
+--------------------+
|     用户界面       |   ← 用户输入数据（密码、账号）
+--------------------+
           |
           v
+------------------------------+
|   小程序前端加密逻辑 (JS)   |
|------------------------------|
| - 用户设置主密码（主密钥）  |
| - 使用 AES / PBKDF2 派生密钥 |
| - 对密码数据进行加密处理     |
+------------------------------+
           |
           v
+------------------------------+
|     加密后的密文数据         |
+------------------------------+
           |
           v
+------------------------------+
|   小程序调用云函数 / API     |
|   上传加密数据至数据库       |
+------------------------------+
           |
           v
+------------------------------+
|    云端数据库（仅存密文）    |
|   密码字段已加密不可读       |
+------------------------------+
```

**查看密码流程：** 用户 → 输入主密码或生物识别 → 前端解密密文 → 显示明文（临时）→ 自动销毁（？）

```
[主密码输入页面]
  ↓
校验 checkKeyHash
  ↓（成功）
生成 derivedKey（基于主密码 + 用户 salt）
  ↓
跳转到密码记录页面
  ↓
[查看密码] ←——（从云端拉密文 + iv）←—— [调用 decryptRecord]
  ↓
[新增密码] ——→（encryptRecord → 上传密文+iv）
```

## 三、流程以及 API 解析

| 步骤 | 描述 | 是否走 API 接口 | 说明 |
| --- | --- | --- | --- |
| **1. 用户设置主密码** | 用户首次使用设定用于所有加解密的主密码。 | **否** | 主密码**仅保存在本地**，用于加解密，不上传服务器。 |
| **2. 前端生成 AES 密钥** | 通过用户主密码派生（PBKDF2）出实际用于加密的 AES 密钥。 | **否** | 本地通过 PBKDF2 等算法计算密钥，用于数据加密解密。 |
| **3. 用户输入账号/密码等内容** | 在本地表单中输入需要保存的账户信息。 | **否** | 用户在本地输入数据，前端处理。 |
| **4. 本地加密数据 (AES)** | 使用派生的 AES 密钥对输入的密码数据进行加密。 | **否** | 在小程序端本地执行 AES 加密操作，防止明文泄露。 |
| **5. 上传加密数据到云数据库** | 将加密后的密文传输到后端服务器保存。 | **是** | 前端调用云函数或自建 API，将密文上传到服务器或云数据库。 |
| **6. 用户查看密码时拉取密文** | 从前端向服务器请求之前保存的密文数据。 | **是** | 从服务器拉取加密后的数据记录，前端本地解密。 |
| **7. 前端本地解密密文 (AES 解密)** | 使用派生的 AES 密钥将拉取的密文解密为明文。 | **否** | 解密过程**完全在本地**完成，不传主密码给服务器。 |
| **8. 显示明文密码 (临时展示)** | 将解密后的明文密码展示给用户查看。 | **否** | 前端内存中临时展示，建议设置定时销毁或遮挡显示。 |
| **9. 更新密码或删除密码** | 用户修改或删除某条已保存的密码记录。 | **是** | 通过 API 调用修改或删除数据库中的密文数据。 |

---

**核心设计原则**：端到端加密，服务端不接触明文或用户主密钥，用户对自己的数据安全负全责。
