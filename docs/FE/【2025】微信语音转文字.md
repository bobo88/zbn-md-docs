# 微信语音转文字（技术实现）

在微信小程序中实现语音转文字功能，可以通过以下两种主流方案实现，具体选择取决于开发需求和资源准备情况：

## 使用微信同声传译插件（推荐）

这是微信官方提供的语音识别插件，集成简单且无需自建服务器，适合快速开发。

### 实现步骤：

#### 1. 添加插件

在小程序管理后台的“插件管理”中搜索并添加“**微信同声传译**”插件（插件 ID：`wx069ba97219f66d99`）。

#### 2. 配置 app.json

在全局配置文件中声明插件：

```json
"plugins": {
  "WechatSI": {
    "version": "0.3.6",
    "provider": "wx069ba97219f66d99"
  }
}
```

#### 3. 代码实现

##### 3.1 初始化插件：

```javascript
const plugin = requirePlugin('WechatSI');
const manager = plugin.getRecordRecognitionManager();
```

##### 3.2 录音控制：

通过 `touchstart` 和 `touchend` 事件控制录音开始与结束，并调用插件的 `start` 和 `stop` 方法。

##### 3.3 结果回调：

监听 `manager.onStop` 事件获取转换后的文字结果，示例代码：

```javascript
manager.onStop = (res) => {
  if (res.result) {
    this.setData({ content: res.result });
    // 触发结果传递或其他逻辑
  }
};
```

**优势**：无需处理音频格式转换，支持实时识别，适合短语音场景。

---

## 完整的示例代码逻辑

```vue
<template>
  <view class="inspiration-page">
    <!-- 其他代码，略... -->

    <!-- 修改录音按钮区域 -->
    <view class="record-area">
      <view
        class="input-box"
        style="
          display: flex;
          padding: 40rpx;
          width: 100% !important;
          background: #fff;
        "
      >
        <u-input
          size="small"
          v-model="urlInput"
          :maxlength="200"
          placeholder="请输入当前灵感内容"
        />

        <view style="margin-left: 10px; width: 100px">
          <u-button type="success" @click="inputAddInspiration"> 生成灵感 </u-button>
        </view>
      </view>

      <!-- 录音区域 -->
      <view
        class="record-btn"
        :class="{ recording: isRecording }"
        @touchstart="startRecording"
        @touchend="stopRecording"
      >
        <u-icon name="mic" color="#fff" size="40"></u-icon>
        <text>{{ isRecording ? '松开结束' : '语音录入' }}</text>
      </view>
      <!-- End -->
    </view>
  </view>
</template>

<script setup lang="ts">
// 其他代码...
// 初始化插件实例
const plugin = ref(null);
const manager = ref(null);
const isRecording = ref(false);

// 数据加载和处理方法
const loadNotes = async () => {
  // 加载数据的逻辑
  // 略...
};

const buildInspiration = async (inputText: any) => {
  // 生成灵感笔记（逻辑）
  // 略...
};

// 初始化语音识别回调
const initRecognition = () => {
  plugin.value = requirePlugin('WechatSI');
  manager.value = plugin.value.getRecordRecognitionManager();

  // 绑定回调事件
  manager.value.onStart = () => {
    isRecording.value = true;
  };

  manager.value.onRecognize = (res) => {
    if (res.result) {
      resultText.value = res.result;
    }
  };

  manager.value.onStop = (res) => {
    isRecording.value = false;
    if (res.result) {
      // 生成灵感
      buildInspiration(res.result || '未能识别语音内容');
    } else {
      console.error('[识别失败]:', res);
    }
  };
};

// 录音操作
const startRecording = () => {
  manager.value.start({
    lang: 'zh_CN',
    duration: 60000,
  });
};

const stopRecording = () => {
  manager.value.stop();
};

const inputAddInspiration = () => {
  // 生成灵感
  buildInspiration(urlInput.value || '手动录入的灵感内容Is Mock.');
  urlInput.value = '';
};

// 生命周期钩子
onMounted(() => {
  // 申请录音权限
  wx.authorize({
    scope: 'scope.record',
    success() {
      console.log('录音权限已授权');
      initRecognition();
    },
    fail() {
      uni.showModal({
        title: '权限提示',
        content: '请前往设置开启录音权限',
        success(res) {
          if (res.confirm) wx.openSetting();
        },
      });
    },
  });
});

onShow(() => {
  loadNotes();
});
</script>

<style lang="scss" scoped>
// 略...
</style>
```

---

**补充说明**：此方案为官方推荐方案，开发者也可选择接入第三方语音识别 API（如科大讯飞、百度 AI 等）实现，但需自行处理音频录制、格式转换和网络传输，复杂度更高。
