# “单点登录”的技术思考

**结论：使用“OAuth2 的授权码模式”实现单点登录。**

OAuth2 授权码模式通过**分离前端授权码和后端令牌交换**，最大化安全性，是企业级单点登录和 API 访问控制的黄金标准。

## 一、实现流程

### 1.1 Token（JWT）

1. 用户登录后，登录中心生成**签名的 JWT** 作为令牌。
2. 将 JWT 传递给客户端（可通过 URL 重定向、PostMessage 或前端存储）。
3. 其他应用通过验证 JWT 签名确认用户身份。

### 1.2 OAuth2 授权码模式

1. 应用 A 将用户重定向到登录中心的授权页（携带 `client_id` 和回调地址）。
2. 用户登录后，登录中心返回 `code` 到应用 A 的回调地址。
3. 应用 A 用 `code` 换取 `access_token`，并访问用户信息。
4. 用户访问应用 B 时，登录中心检测到已有会话，直接授权。

**示例流程：**

1. **重定向：** `https://login.com/auth?client_id=APP1&redirect_uri=https://app1.com/callback`
2. **登录后返回 code：** `https://app1.com/callback?code=ABCDE`
3. **用 code 换 Token 以及获取用户信息等：**
   ```http
   POST https://login.com/token
   grant_type=authorization_code&code=ABCDE&client_secret=XXXXX
   ```

### 1.3 流程图

#### 1.3.1 JWT 流程图

![An image](/images/RD/one-login-1.png)

![An image](/images/RD/one-login-2.png)

#### 1.3.2 OAuth2 授权码模式

![An image](/images/RD/one-login-3.png)

![An image](/images/RD/one-login-4.png)

![An image](/images/RD/one-login-5.png)

## 二、关键技术点

### 2.1 令牌传递

跨域应用通过 URL 重定向传递 Token。例如：`https://app1.com/callback?token=xxxxx`

### 2.2 令牌校验

子应用通过后端验证 Token 有效性（NodeJS 为例）：

```javascript
app.get('/callback', (req, res) => {
  const token = req.query.token;
  try {
    const decoded = jwt.verify(token, 'YOUR_SECRET_KEY');
    // 创建本地会话或直接处理用户请求
  } catch (err) {
    /* 无效令牌处理 */
  }
});
```

### 2.3 授权码的安全性设计

- **短期有效：** 授权码（`code`）有效期通常为 1-5 分钟，且仅能使用一次。
- **前端隔离：** `code` 通过 URL 传递，但最终 `access_token` 由客户端后端通过安全信道（HTTPS + 客户端凭证）换取，避免暴露给浏览器或移动端环境。
- **绑定客户端身份：** 换取令牌时需验证 `client_id` 和 `client_secret`（或 PKCE 的 `code_verifier`）。

### 2.4 重定向 URI 验证

- **白名单机制：** 授权服务器必须校验 `redirect_uri` 是否与预注册的 URI 完全匹配（防止钓鱼）。
- **禁止开放重定向：** 避免攻击者利用回调地址窃取 `code`。

### 2.5 令牌管理

- **短期访问令牌：** `access_token` 有效期较短（如 1 小时），降低泄露风险。
- **刷新令牌（Refresh Token）：**
  - 长期有效，但仅能用于换取新的 `access_token`。
  - 必须安全存储（后端数据库），且可被吊销（如用户主动退出）。

## 三、安全策略

### 3.1 HTTPS

**HTTPS 必选：** 防止 Token 或 Cookie 被窃听。

### 3.2 JWT 安全

- 使用强密钥（HS256 或 RS256）。
- 设置合理的过期时间（如 1 小时）。

### 3.3 二次校验

敏感操作增加二次验证（如密码确认）。

### 3.4 注销机制

- 维护 Token 黑名单（或使用短期 Token 自动过期）。
- 提供全局注销接口，通知所有应用清除会话。

## 四、参考资料

1. [https://moneyslow.com/oauth2-0 和 sso 单点登陆原理.html](https://moneyslow.com/oauth2-0%E5%92%8Csso%E5%8D%95%E7%82%B9%E7%99%BB%E9%99%86%E5%8E%9F%E7%90%86.html)
2. [https://juejin.cn/post/6987207613549117453](https://juejin.cn/post/6987207613549117453)
3. [https://juejin.cn/post/7260851485126082620](https://juejin.cn/post/7260851485126082620)
