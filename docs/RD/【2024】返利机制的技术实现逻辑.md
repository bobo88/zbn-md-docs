# 返利机制的技术实现逻辑

> 作者：Bob，时间：2024.12.02

**目标：** 为了实现一个能够识别代理商代理的买家，即使该买家后续绕过代理商直接购买商家的产品，也依然可以实现代理商的返利计算。

![An image](/images/RD/return-fee.png)

## 图片解析：

1. 任何用户（普通用户、代理商）均可以成为其他用户的推荐人，推荐人最多只有一个；
2. “用户 A”（如果有相关“推荐人 B”）购买商品产生的返利，会被记录在 B 的返利表中；
3. “推荐人 C”可以有 N 个“被推荐人”下单后汇总的返利记录；
4. 返利的形式可以多样化：现金费用、折扣券等；
5. 激励方式：一次性介绍奖励（适合快速拓展用户）、消费返利（适合长期用户活跃和提高用户粘性）。
6. 以上用户 A/B/C 均不特指某个用户。

## 1. 邀请码生成与分发

### 1.1 代理商生成邀请码：

每个代理商在系统中有一个唯一的标识符，商家为代理商提供邀请码的生成工具。每个邀请码与代理商的账户绑定，并附加上代理商 ID。

### 1.2 邀请码格式：

邀请码可以是一个包含代理商 ID 和随机生成的字符组合，例如 `AGENT-12345-XYZ`，其中 `12345` 是代理商 ID，`XYZ` 是随机部分（此部分功能待确定）。

**备注：**

1. 邀请码纯字母（简单好记），有时效性（1 分钟/5 分钟），这样就能更好的保证不会在同时段有重复的邀请码，避免用户与代理商之间的绑定关系发生错乱；
2. 邀请码中带有代理商 ID 或者代理商相关的特定字符，则邀请码可以设置为长期有效。

## 2. 买家注册与使用邀请码

### 2.1 买家注册时输入邀请码：

买家在注册时输入邀请码，系统会根据输入的邀请码识别是哪个代理商的推荐（此时买家与代理商的对应关系将在设定时间内一直绑定。备注：设置时间由商家系统设置）。

### 2.2 记录买家与代理商的关系：

当买家使用邀请码注册时，系统会在数据库中记录买家与对应代理商的关系，字段可以包括代理商 ID 和买家 ID，以便后续跟踪。

### 2.3 避免机器人注册：

在买家注册时，可以加上验证码、手机号验证等手段，防止机器人批量注册。

## 3. 买家购买时的逻辑

### 3.1 购买记录代理商信息：

在买家每次购买时，系统会检查买家是否有绑定的代理商 ID。如果有，购买记录会关联上代理商 ID，以便后续处理。

### 3.2 检测绕过代理商的行为：

如果买家在购买时未输入邀请码或者输入了无效的邀请码，可以通过其他方式（如登录账号、IP 地址、设备指纹等）判断是否为原先绑定过代理商的买家。

- 即便买家未再次使用代理商的邀请码直接下单，系统会通过与买家的账户关联的代理商信息继续记录代理商的影响。

## 4. 返利机制设计

### 4.1 返利机制：

对于通过代理商带来的买家，商家可以设计一个返利机制，保证代理商的利益。如果买家绕过代理商直接下单，系统会依然根据买家的账户信息计算返利。例如，系统可以设置一个“购买周期”，在周期内（如 30 天）进行重复购买时，如果买家曾通过某代理商引导注册，即使绕过代理商购买，依然计算返利。

- **返利周期：** 比如设定一个时间段（如 30 天或 90 天）内，只要买家在此期间内下单，代理商都会得到相应的返利。超过此时间段，买家再购买即视为与原代理商无关。

## 5. 系统流程概述

1. 代理商生成邀请码，并通过社交或其他渠道推广。
2. 买家注册时使用邀请码，系统记录代理商与买家的关系。
3. 买家下单时，系统检查是否有代理商 ID，计算返利。
4. 返利计算：即使买家后续绕过代理商直接购买，系统仍通过买家的账户信息判断是否与代理商有历史关系，从而发放返利。

## 6. 注意事项

- **防止滥用邀请码：** 可以通过限制每个邀请码的使用次数或时间限制来避免滥用。
- **跨平台追踪：** 如果有多个平台（如官网、APP、微信小程序等），需要通过跨平台识别技术（如用户登录凭证、设备指纹等）保持买家与代理商的关联。
- **代理商管理界面：** 提供代理商管理界面，让代理商查看其带来的用户、订单、返利等信息，增强代理商的积极性。

## 7. 实现示例（简化版）

假设你的系统使用了数据库（如 MongoDB 或 MySQL），你可以设计以下表结构（以 MongoDB 为例）：

### users 表（记录买家信息）

```json
{
  "_id": ObjectId("user123"),
  "name": "John Doe",
  "phone": "1234567890",
  "email": "john@example.com",
  "agentId": "agent123",  // 代理商ID，若没有代理商，则为null
  "invitationCode": "AGENT-12345-XYZ", // 用来识别代理商
  "createdAt": ISODate("2024-11-29T12:00:00Z"),
  "updatedAt": ISODate("2024-11-29T12:00:00Z")
}
```

### orders 表（记录订单信息）

```json
{
  "_id": ObjectId("order123"),
  "userId": ObjectId("user123"),
  "totalAmount": 200,
  "products": [
    { "productId": "prod123", "quantity": 2, "price": 100 }
  ],
  "agentId": "agent123",  // 记录关联的代理商
  "orderDate": ISODate("2024-11-29T12:30:00Z"),
  "rebateCalculated": true // 是否已经计算了返利
}
```

### 返利逻辑示例：

- 当 `user123` 下单时，系统会检查该用户的 `agentId`，如果存在，则计算代理商的返利。
- 即使 `user123` 后续没有再次输入邀请码，系统仍能根据 `user123` 的 `agentId` 自动将返利支付给代理商。

**这种方式保证了代理商能够获取通过他们引导来的买家产生的利润，即使买家后续绕过了代理商。**
