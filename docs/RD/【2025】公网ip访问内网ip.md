# 公网 IP 访问内网 IP 方案对比

## 方案选择

| 方案                         | 适用场景              | 所需条件            | 复杂度 |
| ---------------------------- | --------------------- | ------------------- | ------ |
| 1. 端口映射（DNAT）          | 企业有防火墙/NAT 设备 | 可配置防火墙规则    | ⭐⭐   |
| 2. VPN 打通网络              | 无公网 IP，需安全连接 | 可部署 VPN 服务器   | ⭐⭐⭐ |
| 3. 反向代理 + SSH 隧道       | 临时测试/低安全性需求 | 云服务器可 SSH 连接 | ⭐⭐   |
| 4. 内网穿透工具（frp/ngrok） | 无防火墙控制权        | 有中转服务器        | ⭐⭐⭐ |

---

## 方案 1：端口映射（DNAT）

### 适用场景

企业有防火墙/NAT 网关，可将公网 IP 的流量转发到内网。

### 操作步骤

#### 1. 在防火墙/NAT 设备上配置 DNAT 规则

```
公网IP:80 → 内网IP:192.168.1.71:80
```

**a. 华为/思科防火墙示例：**

```bash
nat server global <公网IP> 80 inside 192.168.1.71 80
```

**b. iptables 示例（Linux 网关）：**

```bash
# 启用IP转发
echo 1 > /proc/sys/net/ipv4/ip_forward

# 配置DNAT规则
iptables -t nat -A PREROUTING -d <公网IP> -p tcp --dport 80 \
  -j DNAT --to-destination 192.168.1.71:80

# 配置SNAT规则
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j MASQUERADE
```

#### 2. 云服务器 Nginx 配置

```nginx
server {
    listen 80;
    server_name test1.cdy.cn;

    location / {
        proxy_pass http://192.168.1.71:80;  # 直接指向内网IP
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

#### 3. 验证连通性

```bash
# 在云服务器上测试能否访问内网
curl http://192.168.1.71:80

# 从公网测试
curl http://test1.cdy.cn
```

### 注意事项

- 确保内网服务器防火墙允许云服务器 IP 访问
- 内网服务器需要设置正确的默认网关
- 需要考虑网络延迟和带宽限制

---

## 方案 2：VPN 打通网络

### 适用场景

无公网 IP 映射权限，需加密通信（如 WireGuard/OpenVPN）。

### 操作步骤

#### 1. 在内网部署 VPN 服务器（WireGuard 示例）

**a. 内网服务器（192.168.1.1）安装 WireGuard：**

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install wireguard resolvconf

# 生成密钥对
wg genkey | tee privatekey | wg pubkey > publickey
```

**b. 配置 WireGuard 服务器：**

```ini
# /etc/wireguard/wg0.conf
[Interface]
Address = 10.8.0.1/24
ListenPort = 51820
PrivateKey = <内网服务器私钥>
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

[Peer]
PublicKey = <云服务器公钥>
AllowedIPs = 10.8.0.2/32
```

**c. 启用 WireGuard：**

```bash
sudo systemctl enable wg-quick@wg0
sudo systemctl start wg-quick@wg0
```

#### 2. 云服务器连接 VPN

**a. 安装 WireGuard：**

```bash
sudo apt install wireguard
```

**b. 配置 WireGuard 客户端：**

```ini
# /etc/wireguard/wg0.conf
[Interface]
PrivateKey = <云服务器私钥>
Address = 10.8.0.2/24

[Peer]
PublicKey = <内网VPN服务器公钥>
Endpoint = <内网VPN公网IP或域名>:51820
AllowedIPs = 192.168.1.0/24  # 允许访问内网段
PersistentKeepalive = 25
```

**c. 启动连接：**

```bash
sudo wg-quick up wg0
```

#### 3. Nginx 配置

```nginx
server {
    listen 80;
    server_name test1.cdy.cn;

    location / {
        proxy_pass http://192.168.1.71:80;  # 通过VPN隧道可达
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 优势

- 安全性高，通信加密
- 可以访问整个内网段
- 稳定性好

---

## 方案 3：SSH 隧道（临时测试）

### 适用场景

快速临时访问，无需复杂配置。

### 操作步骤

#### 1. 建立 SSH 反向隧道

```bash
# 在内网机器（能访问192.168.1.71）执行：
ssh -N -R 8080:192.168.1.71:80 root@<云服务器IP>

# 如果需要保持连接，可使用autossh：
autossh -M 0 -N -R 8080:192.168.1.71:80 root@<云服务器IP>
```

#### 2. 云服务器 Nginx 配置

```nginx
server {
    listen 80;
    server_name test1.cdy.cn;

    location / {
        proxy_pass http://127.0.0.1:8080;  # 转发到SSH隧道端口
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

#### 3. 使用 systemd 保持 SSH 隧道（可选）

```ini
# /etc/systemd/system/ssh-tunnel.service
[Unit]
Description=SSH Tunnel Service
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/bin/ssh -N -R 8080:192.168.1.71:80 root@<云服务器IP> -o ServerAliveInterval=60 -o ServerAliveCountMax=3
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**启用服务：**

```bash
sudo systemctl daemon-reload
sudo systemctl enable ssh-tunnel.service
sudo systemctl start ssh-tunnel.service
```

### 注意事项

- SSH 连接可能会超时断开
- 需要配置 SSH 免密登录
- 性能较低，不适合高并发场景

---

## 方案 4：内网穿透工具（frp）

### 适用场景

无防火墙控制权，需通过中转服务器。

### 操作步骤

#### 1. 在中转服务器（云）安装 frp 服务端

**a. 下载 frp：**

```bash
wget https://github.com/fatedier/frp/releases/download/v0.51.3/frp_0.51.3_linux_amd64.tar.gz
tar -zxvf frp_0.51.3_linux_amd64.tar.gz
cd frp_0.51.3_linux_amd64
```

**b. 配置 frp 服务端：**

```ini
# frps.ini
[common]
bind_port = 7000
bind_addr = 0.0.0.0
dashboard_port = 7500
dashboard_user = admin
dashboard_pwd = admin
token = your_token_here
```

**c. 启动 frp 服务端：**

```bash
./frps -c frps.ini

# 使用systemd管理
sudo cp frps /usr/local/bin/
sudo cp systemd/frps.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable frps
sudo systemctl start frps
```

#### 2. 内网机器运行 frp 客户端

**a. 下载并配置 frp 客户端：**

```ini
# frpc.ini
[common]
server_addr = <云服务器IP>
server_port = 7000
token = your_token_here

[web]
type = tcp
local_ip = 192.168.1.71
local_port = 80
remote_port = 60080

[web-http]
type = http
local_port = 80
custom_domains = test1.cdy.cn
```

**b. 启动 frp 客户端：**

```bash
./frpc -c frpc.ini

# 使用systemd管理
sudo cp frpc /usr/local/bin/
sudo cp systemd/frpc.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable frpc
sudo systemctl start frpc
```

#### 3. 云服务器 Nginx 配置

```nginx
server {
    listen 80;
    server_name test1.cdy.cn;

    location / {
        proxy_pass http://127.0.0.1:60080;  # 转发到frp暴露的端口
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### 高级配置（使用 HTTP 模式）

```ini
# frpc.ini（HTTP模式）
[web]
type = http
local_ip = 192.168.1.71
local_port = 80
custom_domains = test1.cdy.cn

# 设置子域名
subdomain = test

# 设置URL路由
locations = /

# 启用HTTPS
use_encryption = true
use_compression = true
```

---

## 方案对比总结

| 特性       | 端口映射 | VPN          | SSH 隧道 | frp       |
| ---------- | -------- | ------------ | -------- | --------- |
| 安全性     | 中       | 高           | 中       | 中        |
| 稳定性     | 高       | 高           | 中       | 高        |
| 配置复杂度 | 中       | 高           | 低       | 中        |
| 维护成本   | 低       | 中           | 高       | 中        |
| 网络延迟   | 低       | 中           | 高       | 中        |
| 适用场景   | 企业内网 | 安全远程办公 | 临时测试 | 无公网 IP |

---

## 推荐方案

### 企业环境推荐

1. **首选：端口映射（DNAT）**

   - 性能最好
   - 配置简单
   - 稳定性高

2. **备选：VPN**
   - 安全性最高
   - 可以访问整个内网

### 个人/开发环境推荐

1. **frp 内网穿透**

   - 配置灵活
   - 支持多种协议
   - 有 Web 管理界面

2. **SSH 隧道**
   - 快速搭建
   - 无需额外软件
   - 适合临时测试

### 安全建议

1. 无论使用哪种方案，都应该：

   - 使用强密码/密钥认证
   - 定期更新软件
   - 监控访问日志
   - 配置防火墙规则限制访问

2. 生产环境建议：
   - 使用 HTTPS 加密传输
   - 配置访问控制列表（ACL）
   - 定期进行安全审计

### 性能优化建议

1. 启用 TCP Keepalive
2. 调整内核网络参数
3. 使用连接池
4. 启用压缩（如果带宽有限）
