# 技术梳理 - 用户权限安全

本文档属于前期梳理工作类型，主要作用是调研：技术可行性、需求完整性、逻辑交互流程等，为后续的【技术实现】做准备。

**备注：**

1. **阶段一：** 共享文档名称前面带有“技术梳理”字样，表示前期调研梳理工作类型的文档；
2. **阶段二：** 共享文档名称前面带有“技术实现”字样，表示正处于技术代码实现阶段（已经完成了初步的调研梳理工作）。

---

## 一、用户权限

在软件系统中，用户权限安全是确保用户只能够访问其被授权的资源和执行其被授权的操作的关键组成部分。

**【"我"让"你"看什么你就只能看什么】** （"我"表示系统管理员，"你"表示用户）

### 1.1 用户身份认证（你是谁？）

用户身份认证是系统确认用户身份的过程，目的是验证“你是谁”，以便可以基于身份进行进一步的授权和权限控制。常见的用户身份认证方式包括：

#### 1.1.1 认证方式

1. **用户名和密码认证：**

   - **原理：** 用户提供用户名和密码，系统通过比对数据库中的记录来验证用户身份。
   - **优点：** 实现简单，适合大多数应用。
   - **缺点：** 若密码设置不当或泄露，安全性较低。
   - **改进措施：** 采用强密码策略，限制密码尝试次数，结合哈希加密（如 bcrypt）。

2. **单点登录（SSO）：**

   - **原理：** 用户只需要登录一次，就可以访问多个不同的系统或服务。
   - **常用协议：** OAuth 2.0、OpenID Connect、SAML 等。
   - **优点：** 提高用户体验，减少多次登录，集中的身份管理。
   - **缺点：** 一旦 SSO 被攻破，所有关联服务的安全都受到威胁。

3. **多因素认证（MFA）：**

   - **原理：** 要求用户在登录时提供两种或以上的验证因素，通常包括：
     1. 知识因素（如密码或 PIN）
     2. 拥有因素（如手机验证码、硬件令牌）
     3. 生物识别因素（如指纹、面部识别）
   - **优点：** 显著提高系统安全性，防止密码泄露导致的身份盗用。
   - **缺点：** 增加用户操作复杂性，可能影响用户体验。

4. **生物识别认证：**
   - **原理：** 通过用户的生物特征进行身份认证，如指纹、虹膜、面部识别等。
   - **优点：** 非常高效且难以伪造。
   - **缺点：** 需要专门的硬件支持，成本较高。

#### 1.1.2 认证过程

1. 用户提交认证信息：用户通过界面提供用户名、密码或其他认证信息。
2. 服务器验证：系统通过查找数据库或第三方身份提供者（如 OAuth 服务）来验证用户信息。
3. 生成认证令牌：验证成功后，系统会为用户生成认证令牌（如 JWT），用于后续请求验证。
4. 响应用户：返回认证结果，允许或拒绝用户访问。

### 1.2 授权和权限控制（你能看什么？）

授权是基于已认证用户身份的基础上，决定该用户能够访问哪些资源和执行哪些操作。通常会使用角色、规则或策略来进行授权。

#### 1.2.1 授权模型

1. **基于角色的访问控制（RBAC）：**

   - **原理：** 通过角色来管理权限。每个用户被分配一个或多个角色，而每个角色拥有一组权限。用户通过角色获得相应的访问权限。
   - **优点：** 简化权限管理，特别是在用户数量较多时。
   - **缺点：** 当权限需求复杂时，RBAC 的灵活性有限，可能需要结合其他策略。
   - **实现方式：**
     - 角色定义：如管理员、普通用户、访客等。
     - 权限分配：定义每个角色可以访问哪些资源和执行哪些操作（如查看、编辑、删除等）。

2. **基于属性的访问控制（ABAC）：**

   - **原理：** 在 ABAC 中，用户、资源和环境的属性会共同影响授权决策。系统会基于这些属性进行动态的权限控制。
   - **优点：** 更加灵活，适用于复杂的权限控制需求，如基于部门、时间、资源类别等。
   - **缺点：** 实现复杂，需要更多的元数据支持。
   - **实现方式：**
     - 用户属性：如职位、所在部门等。
     - 资源属性：如资源的敏感级别、资源类型等。
     - 环境属性：如访问时间、地点等。

3. **基于规则的访问控制（PBAC）：**

   - **原理：** 基于预定义的规则来进行权限判定。用户的操作是否被允许，依赖于预先设置的规则逻辑。
   - **优点：** 支持细粒度权限控制，能动态响应不同的操作场景。
   - **缺点：** 规则定义复杂且可能需要频繁更新。
   - **实现方式：** 定义一套访问规则系统，根据请求的上下文（如操作类型、资源类型等）来动态计算是否允许访问。

4. **访问控制列表（ACL）：**
   - **原理：** 每个资源都有一个权限列表，列出允许访问该资源的用户及其权限。
   - **优点：** 粒度细致，能对每个资源单独设置访问权限。
   - **缺点：** 管理复杂，特别是在资源数目庞大的时候。
   - **实现方式：** 用户与资源的绑定：每个资源维护一个权限列表，列出哪些用户或角色有权限访问该资源。

#### 1.2.2 权限控制的实现

- **静态权限控制：** 通过角色或用户静态地定义哪些资源可以访问、哪些操作可以执行。适用于权限相对稳定的场景。
- **动态权限控制：** 基于具体业务场景，如用户请求的时间、地点、设备等，动态评估是否允许访问某些资源或执行某些操作。

#### 1.2.3 权限分配的注意事项

- **最小权限原则：** 每个用户只被赋予完成任务所需的最低权限。这有助于减少不必要的安全风险。
- **细粒度控制：** 对不同操作、资源进行细粒度的权限控制，不仅控制“谁能看”还要控制“谁能做什么”。
- **定期审查权限：** 定期检查和更新用户的权限，确保不再需要的权限被及时撤销，避免权限滥用。
- **避免权限膨胀：** 当用户逐步获得多个角色或权限时，可能导致过多权限的累积。需要定期清理多余的权限。

---

## 二、技术方案

### 2.1 整体技术栈【OAuth 2.0 + OpenID Connect (OIDC) + JWT】

#### 2.1.1 OAuth 2.0 + OpenID Connect (OIDC)

OAuth 2.0 是一个授权框架，适用于跨应用授权，而 OpenID Connect (OIDC)则是基于 OAuth 2.0 的认证层。

- **优点：**
  - OAuth 2.0 可以在多个服务之间进行安全授权，减少重复登录的需求。
  - OIDC 扩展了 OAuth 2.0，提供了完整的用户身份认证。
  - 支持第三方认证（如 Google、Facebook、微信等）。
  - 安全性高，基于令牌和加密，适合分布式架构。
- **适用场景：**
  - 跨多个项目和平台的 SSO 登录，保证身份认证和授权。
  - 安全性需求较高，支持令牌机制和密钥管理。

#### 2.1.2 JWT (JSON Web Tokens)

- JWT 是一种轻量级的身份验证和信息交换的标准。它在 SSO 场景中非常常见，用于跨服务的身份认证。
- **优点：**
  - 基于 JWT 的 SSO 可以在微服务架构中有效运行，因为它不依赖于服务器存储用户状态。
  - 每个用户登录时生成一个 JWT 令牌，可以用于后续请求的身份验证。
- **适用场景：**
  - 适合微服务架构，前后端分离的应用，跨平台和跨应用的用户登录。

**相关开源解决方案：**

- **Keycloak：** 一个开源的身份和访问管理（IAM）解决方案，支持单点登录（SSO）、身份验证、授权、用户管理等功能。
- **Casdoor：** 可为网页和应用程序用户的登录请求提供服务。
  - 官网：https://casdoor.org/zh/docs/overview/
  - 登录地址：https://door.casdoor.com/login
  - 使用案例：https://www.cnblogs.com/casbin/p/16136664.html

![An image](/images/RD/auth-1.gif)

**认证授权流程示意图：** 整个过程如下图所示，一共分成六个步骤：向用户发送授权请求、获得授权认证、向授权服务器发送授权认证并验证、获取访问令牌、给资源服务器发送访问令牌、获得受保护的资源。

### 2.2 前端技术与主要工作事项

**技术栈：VUE3**

- 登录注册页面：设计并实现登录和注册页面，包括用户输入、验证和错误提示。
- Token 处理：在前端管理 JWT（保存、更新和删除）。
- SSO 单点登录处理：支持多个系统共享登录状态，确保用户在不同系统间无缝切换。
- 权限控制：基于角色的权限显示不同的界面和功能。
- 第三方登录集成：前端集成第三方登录（如 Google、微信等）。
- 错误处理和用户反馈：在身份验证和权限操作中提供详细的错误信息和反馈。
- 前端与后端联调：与后端调试身份验证、授权流程。

### 2.3 后端技术与主要工作事项

**技术栈：Go / Node（Express）**

- OAuth 2.0 认证服务器：实现 OAuth 2.0 授权服务器，处理认证和授权。
- OpenID Connect (OIDC) 支持：
- JWT 生成与验证
- SSO 单点登录支持
- 权限管理系统
- 第三方登录支持
- 日志和安全性加固
- API 接口开发
- 测试与优化

### 2.4 其他配置

TODO

---

## 三、注意事项

### 3.1 最佳实践

- 遵循最小权限原则，只授予必要的权限。
- 定期审查和更新权限，防止权限滥用。
- 实现多层次的防护，确保安全。

---

## 四、相关截图

![An image](/images/RD/auth-2.png)

![An image](/images/RD/auth-3.png)

![An image](/images/RD/auth-4.png)

**流程图地址：** https://www.processon.com/view/60875b7de401fd60cc0921b5
