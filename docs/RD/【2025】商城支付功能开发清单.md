# 商城支付功能开发清单

1）整体流程：商品管理 -- 商品下单支付 -- 商品发货 -- 快递物流完成 -- 售后完成。

2）流程详解：

    a）商品服务：实现商品的增删改查、库存校验...

    b）购物车服务：合并商品、数量校验、关联用户对话

    c）订单服务：创建订单、支付状态机、库存扣减/回滚

    d）支付网关集成：封装微信/支付宝SDK，处理签名验证

    e）物流服务：对接快递鸟、快递100 API，缓存物流信息

3）安全策略：

a）商品管理：

    【权限控制】后台操作需 RBAC 权限验证（如：仅管理员可修改商品价格/库存）

    【权限控制】敏感操作（删除商品）需二次确认 + 操作日志

【数据安全】价格/库存修改时服务端校验数值范围（如：价格 > 0）

b）下单支付：

    【交易安全】订单创建时服务端重新计算总价（防客户端篡改）

    【交易安全】支付回调验证双重签名（防止伪造支付成功）

    【库存安全】下单时使用 分布式锁 + 乐观锁 防止超卖

    【库存安全】支付超时未完成自动释放库存

    【防欺诈】高风险操作（大额支付）触发短信验证

    【防欺诈】同账号短时多次下单自动风控拦截

c）商品发货/物流：

    【数据篡改防护】运单号修改需双重审核（操作员 + 主管权限）

    【数据篡改防护】物流状态变更需验证操作者 IP（限制内网访问）

    【信息披露防护】物流详情中敏感信息脱敏（如收件人手机号显示为 138****1234）

d）售后：

    【权限隔离】用户只能操作自己的售后订单

    【权限隔离】客服处理界面隐藏支付敏感信息（如银行卡号）

    【操作安全】退款金额必须 ≤ 订单实付金额（服务端强校验）

    【操作安全】退货物流单号需调用快递 API 验证有效性

通用安全项：

权限控制 数据安全（比如敏感数据泄露等） 安全漏洞（比如 SQL 注入、XSS 攻击）

4）阶段性产物：

a）商品管理：【通用产物：商品表、API 接口文档】、商品分类树方案调研

b）下单支付：【通用产物：订单表、支付表、API 接口文档】、第三方支付配置文档

c）商品发货/物流：【通用产物：物流表、API 接口文档】、第三方快递 API 接入文档

d）售后：【通用产物：售后表、API 接口文档】

e）其他：库存扣减方案设计、支付状态机设计、物流信息缓存策略

通用产物：

      数据库表（包括ER图等）

      API接口文档

      技术调研文档（如有）

      第三方配置文档（如有）

5）其他：

Common：管理后台

1.页面清单 & API 接口

https://doc.weixin.qq.com/doc/w3_AUEArgZiAEwCNB13oJP17QYevfpBc?scode=AOsAJQfQAFg59gAH7KAUEArgZiAEw

1）登录页面

●login（API）：

2）权限管理页面

3）用户管理页面

4）商品管理页面

5）

一、商品管理模块

核心功能点：商品创建/录入（P0)、上下架（P0）、分类管理（P1）。

1. 商品信息管理

| 功能点 | 前端需求 | 后端需求 | 技术要点 |
| --- | --- | --- | --- |
| 商品创建 | 表单页面（标题/描述/价格/库存等） | RESTful API 设计 | 富文本编辑器集成 |
| 商品编辑 | 数据回显与实时保存 | 事务性更新保证数据一致性 | 图片压缩处理（<200KB） |
| 批量上下架 | 表格操作组件 | 批量状态更新接口 | Redis 缓存商品状态 |
| 分类管理 | 树形组件展示 | 无限级分类数据结构 | 分类路径缓存优化 |
| 搜索筛选 | 组合查询组件 | Elasticsearch 索引构建 | 中文分词优化 |

二、购买流程模块

核心功能点：添加商品（P0）、下单计算处理（P0）、支付（微信、支付宝）（P0）。

1. 购物车系统

| 功能点   | 前端需求      | 后端需求         | 技术要点        |
| -------- | ------------- | ---------------- | --------------- |
| 添加商品 | 动画反馈      | 并发控制防止超卖 | Redis 原子操作  |
| 批量操作 | 全选/删除组件 | 事务性处理       | Lua 脚本执行    |
| 实时计算 | 金额自动更新  | 促销规则引擎     | Groovy 脚本支持 |

2. 结算流程

graph LR A[购物车] --> B{登录校验} B -->|已登录| C[地址管理] B -->|未登录| D[快速注册] C --> E[支付方式选择] E --> F[订单确认] F --> G[支付跳转] G --> H[支付结果回调]

3. 支付集成

TODO: 待补充

三、订单管理模块

核心功能点：订单管理（P0）、物流管理。

1. 订单状态机

stateDiagram-v2 [*] --> 待付款 待付款 --> 已取消： 超时/手动取消 待付款 --> 已支付： 支付成功 已支付 --> 待发货： 库存预占 待发货 --> 已发货： 物流出库 已发货 --> 已签收： 物流妥投 已签收 --> 已完成： 超时自动确认 已完成 --> [*]

2. 核心功能

| 功能点   | 前端需求           | 后端需求     | 技术要点          |
| -------- | ------------------ | ------------ | ----------------- |
| 订单详情 | 时间线组件展示状态 | 多表关联查询 | 读写分离优化      |
| 订单取消 | 原因选择弹窗       | 库存回退逻辑 | 幂等性设计        |
| 超时处理 | -                  | 定时任务扫描 | Quartz 分布式调度 |
| 退款处理 | 流程进度可视化     | 资金逆向操作 | 对账文件生成      |
| 物流跟踪 | 地图轨迹组件       | 物流订阅接口 | Webhook 回调处理  |

四、财务模块

核心功能点：商品交易清单数据（P0）。

| 功能点   | 前端需求       | 后端需求               | 技术要点         |
| -------- | -------------- | ---------------------- | ---------------- |
| 交易报表 | 数据可视化图表 | 多支付渠道对账文件解析 | POI 大数据量导出 |
