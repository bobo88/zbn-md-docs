# IOT 项目架构设计

## 项目概述

中博纳 IOT 项目作为轻量级架构设计，该项目架构设计在满足具体业务的情景下。具有分层、可扩展性强，高实时性、多用户交互、设备联动和极高的可靠性等特点。

## 核心业务场景

- **设备接入**：支持 Wi-Fi、蓝牙、Zigbee 等不同协议的智能设备。
- **实时控制**：通过 APP 或者接口实时控制设备。
- **状态同步**：设备状态变化需实时同步到客户端，客户端可手动更新设备状态。
- **多用户与权限**：支持用户之间共享设备的操作权限，或查看权限。
- **数据与告警**：查看设备历史数据，设备离线等警告。

## 分层设计

可以把系统分成 5 大层，设备层、接入与通信层、平台层、应用层、数据存储层。

- **设备层**：这是系统的终端硬件设备，负责感知和控制物理世界（硬件设备如：光照传感器、ESP32 微控单元等）。

- **接入与通信层**：连接硬件和平台的关键桥梁，我们采用 EMQX 集群来承接设备连接。

- **平台层**：实现设备管理控制、业务逻辑处理、数据存储处理，告警配置等功能平台。

- **应用层**：面向最终用户的应用平台（例如 web 控制台，移动端 app, API 网关）。

- **数据存储层**：存储设备数据，用户数据，操作数据等

## 整体架构图

![An image](/images/loT/IOT项目架构设计.png)

## 技术选型

- **后端主要开发语言**：**Golang** --- 高性能、简洁性和强大的并发支持
- **通信协议**：**MQTT** --- 基于发布/订阅范式的轻量级消息协议。它工作在 TCP/IP 协议族上，专为硬件性能低下的远程设备以及网络状况不佳的环境设计
- **接入层 MQTT Broker**：自建 **EMQX** --- 高性能，低延迟，支持海量连接
- **核心中间件**：**Kafka/RabbitMQ** --- 高吞吐，解耦，持久化，保证数据不丢失
- **数据存储**：关系型数据库（**MySQL**） --- 开源、高性能、稳定、易用、可拓展，时序数据库（**InfluxDB**） --- 为监控数据量身定制，缓存（**Redis**） --- 急速读写，支撑实时状态

## 核心工作流程

- **数据上报**：传感器采集数据 ---> 通过 MQTT 协议发布到 MQTT Broker（EMQX） ---> Broker 将数据转发到消息队列（Kafka）。
- **数据处理**：数据解析服务从 Kafka 消费原始数据 -> 处理后存入时序数据库。
- **指令下发**：应用层向指令服务发送命令 -> 指令服务通过 MQTT Broker 向指定设备下发控制指令。
- **用户交互**：用户打开 App/Web -> 通过 API 网关请求数据 -> 对应的微服务从数据库查询数据并返回 -> 界面渲染图表和状态。

## MQTT 主题设计规范示例

| 类型 | 主题 | 描述 |
| --- | --- | --- |
| **发布** |  |  |
| **设备 \|\| \|\| \|\| v 平台** | `/sys/${productID}/${deviceID}/thing/property/post` | 设备属性上报 |
|  | `/sys/${productID}/${deviceID}/thing/event/post` | 设备事件上报 |
|  | `/sys/${productID}/${deviceID}/thing/property/set_reply` | 设置设备属性响应 |
|  | `/sys/${productID}/${deviceID}/thing/property/query_reply` | 设备属性查询响应 |
|  | `/sys/${productID}/${deviceID}/thing/service/invoke_reply` | 调用设备服务响应 |
| **订阅** |  |  |
| **平台 \| \| \| v 设备** | `/sys/${productID}/${deviceID}/thing/property/post_reply` | 属性上报响应 |
|  | `/sys/${productID}/${deviceID}/thing/event/post_reply` | 事件上报响应 |
|  | `/sys/${productID}/${deviceID}/thing/property/set` | 设置设备属性 |
|  | `/sys/${productID}/${deviceID}/thing/property/query` | 设备属性查询 |
|  | `/sys/${productID}/${deviceID}/thing/service/invoke` | 设备服务调用 |

## 后端功能

### 服务端

服务端功能是整个平台的基础，包括指令服务开发，设备管理服务开发，数据汇集服务开发等

- **指令服务**：平台下发指令到设备，设备上报消息到平台。需调用 EMQX 接口。控制硬件的核心服务
  1.  **指令服务架构设计**：
      ```
      HTTP API  → 指令服务 → MQTT客户端 → 设备
                   ↑             ↓
                   └── 响应通道 ← 异步处理
      ```
- **设备管理服务**：设备添加、修改、删除、查询。为云平台虚拟设备和物理设备做映射关系
- **数据汇集服务**：设备指令消息记录汇总、平台下发指令汇总、设备响应记录汇总。为统计报表数据做支撑
- **消息队列**：搭建 kafka/RabbitMQ 消息队列，接收设备上报回传数据。存储，削峰
- **时序数据库**：搭建 InfluxDB，存储设备最终数据

### Web 后台管理

Web 后台先搭建开发基础模块，优先以满足迅速支撑整个业务运行为主

1.  **用户管理**：添加、删除、修改、查询，用户登录
2.  **产品管理**：添加、删除、修改、查询、物模型管理
3.  **设备管理**：添加、删除、修改、查询、操作记录
4.  **统计**：产品统计、设备统计、消息数统计等

### API

1.  **用户登录**：权限控制
2.  **设备管理**：绑定设备、设备列表、控制设备、设备状态显示、云平台下发设备指令响应
